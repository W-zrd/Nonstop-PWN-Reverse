#!/bin/bash
set -e

# Help message
usage() {
  echo "Usage: $0 [-f] <arm-binary>"
  echo "  -f    Force rebuild of the Docker image even if it exists"
  exit 1
}

# Parse options
FORCE_BUILD=0
while getopts ":f" opt; do
  case $opt in
    f)
      FORCE_BUILD=1
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      usage
      ;;
  esac
done

shift $((OPTIND - 1))

if [ $# -ne 1 ]; then
  usage
fi

BINARY_PATH="$1"
if [ ! -f "$BINARY_PATH" ]; then
  echo "Error: File '$BINARY_PATH' not found!"
  exit 1
fi

BINARY_NAME="$(basename "$BINARY_PATH")"
IMAGE_NAME="${BINARY_NAME%.*}"

# Step 1: Generate random flag
FLAG_CONTENT="CTF{$(head -c 16 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | head -c 24)}"
echo "$FLAG_CONTENT" > flag.txt
echo "[*] Generated flag: $FLAG_CONTENT"

# Step 2: Check if we need to build the Docker image
NEEDS_BUILD=1
if docker image inspect "$IMAGE_NAME" >/dev/null 2>&1 && [ "$FORCE_BUILD" -eq 0 ]; then
  echo "[*] Docker image '$IMAGE_NAME' already exists. Skipping build."
  NEEDS_BUILD=0
fi

if [ "$NEEDS_BUILD" -eq 1 ]; then
  echo "[*] Writing Dockerfile"
  cat > Dockerfile <<EOF
FROM arm64v8/ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive

RUN echo 'Acquire::AllowInsecureRepositories "true";' > /etc/apt/apt.conf.d/99insecure && \
    echo 'APT::Get::AllowUnauthenticated "true";' >> /etc/apt/apt.conf.d/99insecure && \
    apt-get update --allow-insecure-repositories && \
    apt-get install -y --allow-unauthenticated gdb lldb socat build-essential && \
    adduser --disabled-password --gecos "" ctf

WORKDIR /home/ctf
COPY $BINARY_PATH /home/ctf/$BINARY_NAME
COPY flag.txt /home/ctf/flag.txt
RUN chmod +x /home/ctf/$BINARY_NAME

USER ctf
EXPOSE 1337 4444 1234

CMD ["socat", "TCP-LISTEN:1337,reuseaddr,fork", "EXEC:/home/ctf/$BINARY_NAME"]
EOF

  echo "[*] Setting up docker buildx (if not already initialized)"
  docker buildx create --use || echo "[*] buildx already exists, continuing..."

  echo "[*] Building Docker image '$IMAGE_NAME' for ARM64"
  docker buildx build --platform linux/arm64 -t "$IMAGE_NAME" . --load
fi

# Step 3: Run the container
echo "[*] Running container '$IMAGE_NAME' on ports 1337, 1234, 4444"
docker run -it -p 1337:1337 -p 1234:1234 -p 4444:4444 "$IMAGE_NAME"